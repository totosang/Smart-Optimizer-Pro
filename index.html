<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Smart Optimizer</title>
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap" rel="stylesheet">
<style>:root{--p:#8b3dff;--b:#f3f4f9;--c:#fff;--d:#ff4d4d}body{font-family:Sarabun,sans-serif;background-color:var(--b);margin:0;display:flex;flex-direction:column;align-items:center}.app-header{width:100%;background:#fff;padding:15px 0;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,.05);position:sticky;top:0;z-index:100}.container{width:95%;max-width:500px;padding:20px 0}.control-panel{background:var(--c);border-radius:16px;padding:20px;box-shadow:0 8px 24px rgba(0,0,0,.08);margin-bottom:20px;display:flex;flex-direction:column;gap:15px}.input-sync-row{display:flex;align-items:center;gap:10px}input[type=range]{flex:1;accent-color:var(--p)}input[type=number],select{padding:12px;border-radius:10px;border:1px solid #ddd}.num-input{width:75px;text-align:center}.drop-zone{border:2px dashed #d1d5db;border-radius:16px;padding:30px 20px;text-align:center;background:#fafafa;cursor:pointer;margin-bottom:20px}.info-badge{background:#eef2ff;color:var(--p);padding:12px;border-radius:8px;font-size:.9rem;text-align:center;font-weight:700}#p-l{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;width:100%}.page-card{background:#fff;border-radius:12px;padding:10px;box-shadow:0 2px 8px rgba(0,0,0,.05);position:relative}.card-actions{display:flex;justify-content:space-between;margin-bottom:5px}.btn-icon{background:#eee;border:none;border-radius:50%;width:28px;height:28px;cursor:pointer;display:flex;align-items:center;justify-content:center}.btn-del{color:var(--d)}.canvas-container-custom{display:flex;justify-content:center;align-items:center;background:#f0f0f0;border-radius:8px;min-height:150px;overflow:hidden}.kb-label{font-size:11px;color:#333;margin-top:8px;display:block}.btn-main{background:var(--p);color:#fff;padding:16px;border-radius:12px;border:none;font-size:1.1rem;font-weight:700;cursor:pointer;width:100%}</style>
</head>
<body>
<div class="app-header"><h2>‚ú® Smart Optimizer Pro</h2></div>
<div class="container">
    <div class="drop-zone" id="d-z"><span style="font-size:2rem">üì•</span><br>‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î</div>
    <input type="file" id="f-i" multiple accept="image/*,application/pdf" style="display:none">
    <div class="control-panel">
        <label>üìâ ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô (%)</label>
        <div class="input-sync-row">
            <input type="range" id="s-s" min="1" max="100" value="100" oninput="_sy('s')">
            <input type="number" id="s-n" min="1" max="100" value="100" class="num-input" oninput="_sy('n')">
            <span>%</span>
        </div>
        <select id="e-f"><option value="image/jpeg">JPG</option><option value="image/png">PNG</option><option value="pdf">PDF</option></select>
        <div class="info-badge" id="o-s">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</div>
        <button class="btn-main" onclick="_ex()">üíæ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</button>
    </div>
    <div id="p-l"></div>
</div>
<script>
(function(){pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';let _fd=[];const _gi=i=>document.getElementById(i),_dz=_gi('d-z'),_fi=_gi('f-i');const _fu=k=>`${parseFloat(k).toLocaleString(undefined,{minimumFractionDigits:1})} Kb`;window._sy=(t)=>{const s=_gi('s-s'),n=_gi('s-n');if(t==='s')n.value=s.value;else s.value=n.value;_up()};_dz.onclick=()=>_fi.click();_fi.onchange=e=>_hf(e.target.files);_dz.ondragover=e=>e.preventDefault();_dz.ondrop=e=>{e.preventDefault();_hf(e.dataTransfer.files)};async function _hf(fs){for(const f of fs){const ok=(f.size/1024).toFixed(1);if(f.type==='application/pdf'){const d=await pdfjsLib.getDocument({data:await f.arrayBuffer()}).promise;for(let i=1;i<=d.numPages;i++){const p=await d.getPage(i),v=p.getViewport({scale:2}),c=document.createElement('canvas');c.width=v.width;c.height=v.height;await p.render({canvasContext:c.getContext('2d'),viewport:v}).promise;const b=await new Promise(r=>c.toBlob(r,'image/png',1));fabric.Image.fromURL(URL.createObjectURL(b),m=>_ad(m,`P${i}_${f.name}`,ok))}}else{fabric.Image.fromURL(URL.createObjectURL(f),m=>_ad(m,f.name,ok))}}}function _ad(m,n,o){const id='id-'+Math.random().toString(36).substr(2,9);_fd.push({id,img:m,name:n,rotation:0,ok:parseFloat(o)});const cd=document.createElement('div');cd.className='page-card';cd.id='c-'+id;cd.innerHTML=`<div class="card-actions"><button class="btn-icon" onclick="_rt('${id}')">üîÑ</button><button class="btn-icon btn-del" onclick="_rm('${id}')">‚ùå</button></div><div class="canvas-container-custom"><canvas id="cv-${id}"></canvas></div><span class="kb-label" id="lb-${id}"></span>`;_gi('p-l').appendChild(cd);_up()}function _up(){const pc=_gi('s-s').value/100,ds=Math.sqrt(pc);_fd.forEach(it=>{const cE=_gi(`cv-${it.id}`),fc=new fabric.StaticCanvas(cE),ir=(it.rotation/90)%2!==0,fs=(150/Math.max(it.img.width,it.img.height))*ds,w=(ir?it.img.height:it.img.width)*fs,h=(ir?it.img.width:it.img.height)*fs;fc.setDimensions({width:w,height:h});const tm=fabric.util.object.clone(it.img);tm.set({angle:it.rotation,originX:'center',originY:'center',left:w/2,top:h/2});tm.scale(fs);fc.add(tm);fc.renderAll();const ek=(it.ok*pc).toFixed(1);_gi(`lb-${it.id}`).innerHTML=`‡πÄ‡∏î‡∏¥‡∏°: ${_fu(it.ok)}<br>‡πÉ‡∏´‡∏°‡πà: <b>${_fu(ek)}</b>`});const tt=_fd.reduce((a,b)=>a+(b.ok*pc),0);_gi('o-s').innerText=`‡∏£‡∏ß‡∏°‡πÉ‡∏´‡∏°‡πà: ${_fu(tt.toFixed(1))}`}window._rt=i=>{const it=_fd.find(f=>f.id===i);it.rotation=(it.rotation-90)%360;_up()};window._rm=i=>{_fd=_fd.filter(f=>f.id!==i);_gi('c-'+i).remove();_up()};window._ex=async()=>{if(!_fd.length)return alert("‡∏ß‡πà‡∏≤‡∏á!");const pc=_gi('s-s').value/100,ds=Math.sqrt(pc),ft=_gi('e-f').value,zp=new JSZip(),{PDFDocument:PD}=PDFLib,pD=await PD.create();let ex=[];for(const it of _fd){const ir=(it.rotation/90)%2!==0,w=(ir?it.img.height:it.img.width)*ds,h=(ir?it.img.width:it.img.height)*ds,tC=document.createElement('canvas');tC.width=w;tC.height=h;const fc=new fabric.StaticCanvas(tC),ei=fabric.util.object.clone(it.img);ei.set({angle:it.rotation,originX:'center',originY:'center',left:w/2,top:h/2});ei.scale(ds);fc.add(ei);fc.renderAll();const q=ft==='image/jpeg'?.95:1,du=tC.toDataURL(ft==='pdf'?'image/jpeg':ft,q);if(ft==='pdf'){const pg=pD.addPage([w,h]);pg.drawImage(await pD.embedJpg(du),{x:0,y:0,width:w,height:h})}else ex.push({n:`${it.name.split('.')[0]}_min.${ft.split('/')[1]}`,d:du})}if(ft==='pdf')_db(new Blob([await pD.save()]),"min.pdf");else if(ex.length===1){const a=document.createElement('a');a.href=ex[0].d;a.download=ex[0].n;a.click()}else{ex.forEach(f=>zp.file(f.n,f.d.split(',')[1],{base64:true}));_db(await zp.generateAsync({type:"blob"}),"min.zip")}};function _db(b,n){const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=n;a.click()}})()
</script>
</body>
</html>
